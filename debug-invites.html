<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Debug Invite Codes</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #1a1a1a; color: #fff; }
    button { padding: 10px 20px; margin: 10px; cursor: pointer; background: #4CAF50; border: none; color: white; border-radius: 5px; }
    pre { background: #2a2a2a; padding: 15px; border-radius: 5px; overflow-x: auto; }
    .error { color: #ff4444; }
    .success { color: #4CAF50; }
    .warning { color: #ffaa00; }
  </style>
</head>
<body>
  <h1>ğŸ” Debug Invite Codes System</h1>

  <button onclick="testReadAllInvites()">1ï¸âƒ£ Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡ Ú©Ø¯Ù‡Ø§ÛŒ Ø¯Ø¹ÙˆØª</button>
  <button onclick="testValidateCode()">2ï¸âƒ£ ØªØ³Øª Ú©Ø¯ Ø®Ø§Øµ</button>
  <button onclick="testFirestoreConnection()">3ï¸âƒ£ ØªØ³Øª Ø§ØªØµØ§Ù„ Firestore</button>

  <div style="margin-top: 20px;">
    <label>Ú©Ø¯ Ø¯Ø¹ÙˆØª Ø¨Ø±Ø§ÛŒ ØªØ³Øª:</label>
    <input type="text" id="testCode" placeholder="BZL3EC7V" style="padding: 5px; width: 200px;">
  </div>

  <pre id="output">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ³Øª...</pre>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBE8gmrTNdsFb_Ho15mDQap2VzyLsxudU4",
      authDomain: "topanalyzertrade.firebaseapp.com",
      projectId: "topanalyzertrade",
      storageBucket: "topanalyzertrade.firebasestorage.app",
      messagingSenderId: "412033042169",
      appId: "1:412033042169:web:8270d77380b880edaa4428",
      measurementId: "G-CVC3FWXPH1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const output = document.getElementById('output');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('fa-IR');
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
    }

    function clearOutput() {
      output.innerHTML = '';
    }

    // Test 1: Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ù…Ù‡ Ú©Ø¯Ù‡Ø§ÛŒ Ø¯Ø¹ÙˆØª
    window.testReadAllInvites = async function() {
      clearOutput();
      log('ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ù…Ù‡ Ú©Ø¯Ù‡Ø§ÛŒ Ø¯Ø¹ÙˆØª Ø§Ø² Firestore...');

      try {
        const invitesSnapshot = await getDocs(collection(db, 'invites'));

        if (invitesSnapshot.empty) {
          log('âš ï¸ Ù‡ÛŒÚ† Ú©Ø¯ Ø¯Ø¹ÙˆØªÛŒ Ø¯Ø± database ÛŒØ§ÙØª Ù†Ø´Ø¯!', 'warning');
          return;
        }

        log(`âœ… ØªØ¹Ø¯Ø§Ø¯ Ú©Ø¯Ù‡Ø§ÛŒ Ø¯Ø¹ÙˆØª: ${invitesSnapshot.size}`, 'success');
        log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

        invitesSnapshot.forEach((doc, index) => {
          const data = doc.data();
          log(`ğŸ“‹ Ú©Ø¯ ${index + 1}:`);
          log(`   ID: ${doc.id}`);
          log(`   Code: ${data.code}`);
          log(`   Status: ${data.status}`);
          log(`   Created By: ${data.createdBy || 'N/A'}`);
          log(`   Used By: ${data.usedBy || 'Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡'}`);
          log(`   Created At: ${data.createdAt ? new Date(data.createdAt.toDate()).toLocaleString('fa-IR') : 'N/A'}`);
          log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
        });

      } catch (error) {
        log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ú©Ø¯Ù‡Ø§ÛŒ Ø¯Ø¹ÙˆØª:`, 'error');
        log(`   Error Code: ${error.code}`, 'error');
        log(`   Error Message: ${error.message}`, 'error');
        console.error('Full error:', error);
      }
    };

    // Test 2: ØªØ³Øª Ú©Ø¯ Ø®Ø§Øµ
    window.testValidateCode = async function() {
      clearOutput();
      const testCode = document.getElementById('testCode').value.toUpperCase();

      if (!testCode) {
        log('âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú©Ø¯ Ø¯Ø¹ÙˆØª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }

      log(`ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ Ú©Ø¯: ${testCode}`);

      try {
        // Method 1: Query Ø¨Ø§ where
        log('\nğŸ“ Ø±ÙˆØ´ 1: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Query');
        const invitesQuery = query(
          collection(db, 'invites'),
          where('code', '==', testCode),
          where('status', '==', 'active')
        );

        const querySnapshot = await getDocs(invitesQuery);

        if (querySnapshot.empty) {
          log('âŒ Ú©Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ Ø¨Ø§ Query', 'error');

          // Ø¨ÛŒØ§ÛŒÛŒØ¯ Ø¨Ø¨ÛŒÙ†ÛŒÙ… Ø¢ÛŒØ§ Ø¨Ø§ status Ø¯ÛŒÚ¯Ù‡â€ŒØ§ÛŒ Ù‡Ø³Øª
          const allCodesQuery = query(
            collection(db, 'invites'),
            where('code', '==', testCode)
          );
          const allCodesSnapshot = await getDocs(allCodesQuery);

          if (allCodesSnapshot.empty) {
            log('âŒ Ø§ÛŒÙ† Ú©Ø¯ Ø§ØµÙ„Ø§Ù‹ Ø¯Ø± database ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!', 'error');
          } else {
            allCodesSnapshot.forEach(doc => {
              const data = doc.data();
              log(`âš ï¸ Ú©Ø¯ ÛŒØ§ÙØª Ø´Ø¯ Ø§Ù…Ø§ status Ø¢Ù† "${data.status}" Ø§Ø³Øª`, 'warning');
            });
          }
        } else {
          log('âœ… Ú©Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾ÛŒØ¯Ø§ Ø´Ø¯!', 'success');
          querySnapshot.forEach(doc => {
            const data = doc.data();
            log(`   ID: ${doc.id}`);
            log(`   Code: ${data.code}`);
            log(`   Status: ${data.status}`);
            log(`   Used By: ${data.usedBy || 'Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡'}`);
          });
        }

        // Method 2: Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ù…Ù‡ Ùˆ Ù…Ù‚Ø§ÛŒØ³Ù‡
        log('\nğŸ“ Ø±ÙˆØ´ 2: Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ù…Ù‡ Ùˆ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¯Ø³ØªÛŒ');
        const allInvites = await getDocs(collection(db, 'invites'));
        let found = false;

        allInvites.forEach(doc => {
          const data = doc.data();
          if (data.code === testCode) {
            found = true;
            log(`âœ… Ú©Ø¯ Ù¾ÛŒØ¯Ø§ Ø´Ø¯ Ø¯Ø± Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„:`, 'success');
            log(`   Status: ${data.status}`);
            log(`   Match: ${data.code === testCode ? 'Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ ÛŒÚ©Ø³Ø§Ù†' : 'Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯'}`);
          }
        });

        if (!found) {
          log('âŒ Ú©Ø¯ Ø¯Ø± Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ù‡Ù… Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯', 'error');
        }

      } catch (error) {
        log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª Ú©Ø¯:`, 'error');
        log(`   Error Code: ${error.code}`, 'error');
        log(`   Error Message: ${error.message}`, 'error');
        console.error('Full error:', error);
      }
    };

    // Test 3: ØªØ³Øª Ø§ØªØµØ§Ù„
    window.testFirestoreConnection = async function() {
      clearOutput();
      log('ğŸ” Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Firestore...');

      try {
        // ØªØ³Øª Ø®ÙˆØ§Ù†Ø¯Ù† ÛŒÚ© collection
        const testSnapshot = await getDocs(collection(db, 'invites'));
        log('âœ… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Firestore Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯!', 'success');
        log(`   ØªØ¹Ø¯Ø§Ø¯ documents Ø¯Ø± invites: ${testSnapshot.size}`);

        // Ú†Ú© Ú©Ø±Ø¯Ù† Rules
        log('\nğŸ“ ØªØ³Øª Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§:');
        log('   âœ… Read access: Ø¯Ø§Ø±Ø¯ (Ú†ÙˆÙ† ØªÙˆØ§Ù†Ø³ØªÛŒÙ… Ø¨Ø®ÙˆØ§Ù†ÛŒÙ…)');

      } catch (error) {
        log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„:`, 'error');
        log(`   Error Code: ${error.code}`, 'error');
        log(`   Error Message: ${error.message}`, 'error');

        if (error.code === 'permission-denied') {
          log('   ğŸ’¡ Ù…Ø´Ú©Ù„: Firestore Rules Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ù…ÛŒØ¯Ù‡Ø¯', 'warning');
        }
      }
    };

    // Auto-run first test
    setTimeout(() => {
      log('ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ³Øª Ø§ÙˆÙ„...\n');
      testReadAllInvites();
    }, 500);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Fix Missing User Documents</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #1a1a1a; color: #fff; }
    button { padding: 10px 20px; margin: 10px; cursor: pointer; background: #4CAF50; border: none; color: white; border-radius: 5px; }
    .error { color: #ff4444; }
    .success { color: #4CAF50; }
    .warning { color: #ffaa00; }
    pre { background: #2a2a2a; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>ğŸ”§ Fix Missing User Documents</h1>

  <p>Ø§ÛŒÙ† Ø§Ø¨Ø²Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ÛŒ Ú©Ù‡ ÙÙ‚Ø· Ø¯Ø± Authentication Ù‡Ø³ØªÙ†Ø¯ ÙˆÙ„ÛŒ document Ø¯Ø± Firestore Ù†Ø¯Ø§Ø±Ù†Ø¯ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ùˆ Ø¯Ø±Ø³Øª Ù…ÛŒÚ©Ù†Ø¯.</p>

  <button onclick="checkAndFixUsers()">Ú†Ú© Ùˆ Ø¯Ø±Ø³Øª Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>

  <pre id="output">Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹...</pre>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBE8gmrTNdsFb_Ho15mDQap2VzyLsxudU4",
      authDomain: "topanalyzertrade.firebaseapp.com",
      projectId: "topanalyzertrade",
      storageBucket: "topanalyzertrade.firebasestorage.app",
      messagingSenderId: "412033042169",
      appId: "1:412033042169:web:8270d77380b880edaa4428",
      measurementId: "G-CVC3FWXPH1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const output = document.getElementById('output');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('fa-IR');
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
    }

    function clearOutput() {
      output.innerHTML = '';
    }

    // Ú†Ú© Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        log(`âœ… Ø´Ù…Ø§ Ù„Ø§Ú¯ÛŒÙ† Ù‡Ø³ØªÛŒØ¯: ${user.email}`, 'success');
      } else {
        log('âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø§ÙˆÙ„ Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†ÛŒØ¯!', 'warning');
      }
    });

    window.checkAndFixUsers = async function() {
      clearOutput();

      const currentUser = auth.currentUser;

      if (!currentUser) {
        log('âŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ø³Ø§ÛŒØª Ø§ØµÙ„ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†ÛŒØ¯!', 'error');
        log('ğŸ’¡ Ø¨Ø±Ùˆ Ø¨Ù‡ topintrade.com Ùˆ login Ú©Ù†ØŒ Ø¨Ø¹Ø¯ Ø¨Ø±Ú¯Ø±Ø¯ Ø§ÛŒÙ†Ø¬Ø§', 'warning');
        return;
      }

      log(`ğŸ” Ú†Ú© Ù…ÛŒÚ©Ù†ÛŒÙ… Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ: ${currentUser.email}`);
      log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

      try {
        // Ú†Ú© document Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ Ø¯Ø± Firestore
        const userDocRef = doc(db, 'users', currentUser.uid);
        const userDoc = await getDoc(userDocRef);

        if (!userDoc.exists()) {
          log('âŒ Document Ø´Ù…Ø§ Ø¯Ø± Firestore ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!', 'error');
          log('ğŸ“ Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª document...', 'warning');

          // Ø³Ø§Ø®Øª document
          await setDoc(userDocRef, {
            email: currentUser.email,
            displayName: currentUser.displayName || currentUser.email.split('@')[0],
            photoURL: currentUser.photoURL || null,
            createdAt: serverTimestamp(),
            lastLogin: serverTimestamp(),
            isAdmin: false
          });

          log('âœ… Document Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!', 'success');
          log(`   UID: ${currentUser.uid}`);
          log(`   Email: ${currentUser.email}`);
          log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
          log('ğŸ‰ Ø­Ø§Ù„Ø§ Ù…ÛŒØªÙˆÙ†ÛŒØ¯ Ø¨Ù‡ Ø³Ø§ÛŒØª Ø¨Ø±ÛŒØ¯!', 'success');
        } else {
          log('âœ… Document Ø´Ù…Ø§ Ø¯Ø± Firestore ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯', 'success');
          const data = userDoc.data();
          log(`   Email: ${data.email}`);
          log(`   Display Name: ${data.displayName || 'N/A'}`);
          log(`   Created At: ${data.createdAt ? new Date(data.createdAt.toDate()).toLocaleString('fa-IR') : 'N/A'}`);
          log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
          log('âœ… Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¯Ø±Ø³ØªÙ‡!', 'success');
        }

      } catch (error) {
        log('âŒ Ø®Ø·Ø§ Ø±Ø® Ø¯Ø§Ø¯:', 'error');
        log(`   ${error.message}`, 'error');
        console.error('Full error:', error);
      }
    };
  </script>

  <hr style="margin: 40px 0; border-color: #444;">

  <h2>ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§:</h2>
  <ol style="line-height: 2;">
    <li>Ø§Ú¯Ù‡ Ù„Ø§Ú¯ÛŒÙ† Ù†ÛŒØ³ØªÛŒØŒ Ø¨Ø±Ùˆ Ø¨Ù‡ <a href="https://topintrade.com" style="color: #4CAF50;">topintrade.com</a> Ùˆ login Ú©Ù†</li>
    <li>Ø¨Ø¹Ø¯ Ø¨Ø±Ú¯Ø±Ø¯ Ø§ÛŒÙ†Ø¬Ø§ Ùˆ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ù„Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†</li>
    <li>Ø§Ú¯Ù‡ document Ù†Ø¯Ø§Ø´ØªÛŒØŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø±Ø³Øª Ù…ÛŒØ´Ù‡</li>
    <li>Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø±Ùˆ Ø³Ø§ÛŒØª Ùˆ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†</li>
  </ol>
</body>
</html>

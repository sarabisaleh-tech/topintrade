<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Admin: Fix All Users</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #1a1a1a; color: #fff; max-width: 1200px; margin: 0 auto; }
    button { padding: 10px 20px; margin: 10px; cursor: pointer; background: #4CAF50; border: none; color: white; border-radius: 5px; font-size: 16px; }
    button:disabled { background: #666; cursor: not-allowed; }
    .error { color: #ff4444; }
    .success { color: #4CAF50; }
    .warning { color: #ffaa00; }
    pre { background: #2a2a2a; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; max-height: 600px; overflow-y: auto; }
    h1 { color: #4CAF50; }
    .login-section { background: #2a2a2a; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    input { padding: 10px; width: 300px; border-radius: 5px; border: 1px solid #444; background: #333; color: #fff; margin: 5px; }
  </style>
</head>
<body>
  <h1>ğŸ”§ Admin Panel: Fix Missing User Documents</h1>

  <div class="login-section" id="loginSection">
    <h2>ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†</h2>
    <p>Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ† Ø§Ø¨Ø²Ø§Ø±ØŒ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø§Ú©Ø§Ù†Øª Ø§Ø¯Ù…ÛŒÙ† login Ú©Ù†ÛŒØ¯.</p>
    <div>
      <input type="email" id="adminEmail" placeholder="Ø§ÛŒÙ…ÛŒÙ„ Ø§Ø¯Ù…ÛŒÙ†" value="sarabisaleh@gmail.com">
      <input type="password" id="adminPassword" placeholder="Ù¾Ø³ÙˆØ±Ø¯">
      <button onclick="adminLogin()">ÙˆØ±ÙˆØ¯</button>
    </div>
  </div>

  <div id="toolsSection" style="display: none;">
    <p><strong class="warning">âš ï¸ Ø§ÛŒÙ† Ø§Ø¨Ø²Ø§Ø± ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª!</strong></p>
    <p>Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ÛŒ Ú©Ù‡ ÙÙ‚Ø· Ø¯Ø± Authentication Ù‡Ø³ØªÙ†Ø¯ ÙˆÙ„ÛŒ document Ø¯Ø± Firestore Ù†Ø¯Ø§Ø±Ù†Ø¯ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ùˆ Ø¯Ø±Ø³Øª Ù…ÛŒÚ©Ù†Ø¯.</p>

    <button onclick="fixSpecificUser()">Ø¯Ø±Ø³Øª Ú©Ø±Ø¯Ù† ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø®Ø§Øµ</button>
    <input type="text" id="specificUID" placeholder="UID Ú©Ø§Ø±Ø¨Ø±" style="width: 400px;">

    <hr>
    <p class="success">Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Firebase Ø§Ø² browser Ø§Ø¬Ø§Ø²Ù‡ list Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ users Ø±Ùˆ Ù†Ù…ÛŒØ¯Ù‡. ÙÙ‚Ø· Ù…ÛŒØªÙˆÙ†ÛŒÙ… ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø®Ø§Øµ Ø±Ùˆ fix Ú©Ù†ÛŒÙ….</p>
  </div>

  <pre id="output">Ø¢Ù…Ø§Ø¯Ù‡...</pre>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBE8gmrTNdsFb_Ho15mDQap2VzyLsxudU4",
      authDomain: "topanalyzertrade.firebaseapp.com",
      projectId: "topanalyzertrade",
      storageBucket: "topanalyzertrade.firebasestorage.app",
      messagingSenderId: "412033042169",
      appId: "1:412033042169:web:8270d77380b880edaa4428"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const output = document.getElementById('output');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('fa-IR');
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    function clearOutput() {
      output.innerHTML = '';
    }

    window.adminLogin = async function() {
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;

      if (!email || !password) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ù¾Ø³ÙˆØ±Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
      }

      clearOutput();
      log('ğŸ” Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...', 'warning');

      try {
        await signInWithEmailAndPassword(auth, email, password);
        log('âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚!', 'success');
        log(`   Ø§ÛŒÙ…ÛŒÙ„: ${email}`);

        // Check if admin
        const adminEmails = ['salehsarubi@gmail.com', 'sarabisaleh@gmail.com'];
        if (!adminEmails.includes(email.toLowerCase())) {
          log('âŒ Ø´Ù…Ø§ Ø§Ø¯Ù…ÛŒÙ† Ù†ÛŒØ³ØªÛŒØ¯!', 'error');
          return;
        }

        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('toolsSection').style.display = 'block';

      } catch (error) {
        log('âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯:', 'error');
        log(`   ${error.message}`, 'error');
      }
    };

    window.fixSpecificUser = async function() {
      const uid = document.getElementById('specificUID').value.trim();

      if (!uid) {
        alert('Ù„Ø·ÙØ§Ù‹ UID Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
      }

      clearOutput();
      log(`ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ UID: ${uid}`);
      log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

      try {
        const userDocRef = doc(db, 'users', uid);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists()) {
          log('âœ… Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ document Ø¯Ø§Ø±Ù‡', 'success');
          const data = userDoc.data();
          log(`   Email: ${data.email}`);
          log(`   Username: ${data.username || 'N/A'}`);
          log(`   Created: ${data.createdAt ? new Date(data.createdAt.toDate()).toLocaleString('fa-IR') : 'N/A'}`);
        } else {
          log('âŒ Document ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!', 'error');
          log('ğŸ’¡ Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù†Ù…ÛŒØªÙˆÙ†ÛŒÙ… Ø§Ø² Ø§ÛŒÙ†Ø¬Ø§ Ø¨ÙÙ‡Ù…ÛŒÙ… Ø§ÛŒÙ…ÛŒÙ„ Ø§ÛŒÙ† UID Ú†ÛŒÙ‡', 'warning');
          log('ğŸ“ Ø¨Ø§ÛŒØ¯ Ø¯Ø³ØªÛŒ document Ø±Ùˆ Ø¨Ø³Ø§Ø²ÛŒÙ…');
          log('');

          const email = prompt('Ø§ÛŒÙ…ÛŒÙ„ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ú†ÛŒÙ‡ØŸ');
          if (!email) {
            log('âŒ Ù„ØºÙˆ Ø´Ø¯', 'error');
            return;
          }

          log(`ğŸ“ Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª document Ø¨Ø±Ø§ÛŒ: ${email}`);

          await setDoc(userDocRef, {
            email: email,
            username: email.split('@')[0],
            displayName: email.split('@')[0],
            createdAt: serverTimestamp(),
            lastLogin: serverTimestamp(),
            isAdmin: false
          });

          log('âœ… Document Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!', 'success');
          log(`   Ø­Ø§Ù„Ø§ Ú©Ø§Ø±Ø¨Ø± ${email} Ù…ÛŒØªÙˆÙ†Ù‡ login Ú©Ù†Ù‡`);
        }

      } catch (error) {
        log('âŒ Ø®Ø·Ø§:', 'error');
        log(`   ${error.message}`, 'error');
        console.error(error);
      }
    };
  </script>
</body>
</html>
